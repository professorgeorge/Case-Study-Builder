<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#1e293b">
<meta name="description" content="A step-by-step tool for building management case studies. Designed for classroom use.">
<title>Case Study Builder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:ital,wght@0,400;0,500;0,600;1,400&display=swap" rel="stylesheet">

<!-- PWA Manifest -->
<link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkNhc2UgU3R1ZHkgQnVpbGRlciAtIEJ1c2luZXNzIE1hbmFnZW1lbnQgVGVhY2hpbmcgVG9vbCIsCiAgInNob3J0X25hbWUiOiAiQ2FzZSBCdWlsZGVyIiwKICAiZGVzY3JpcHRpb24iOiAiQW4gaW50ZXJhY3RpdmUgY2FzZSBzdHVkeSBidWlsZGVyIGZvciBidXNpbmVzcyBtYW5hZ2VtZW50IHN0dWRlbnRzLiBDcmVhdGUgY29tcHJlaGVuc2l2ZSwgdGhvdWdodC1wcm92b2tpbmcgY2FzZSBzdHVkaWVzIGZvciBjbGFzc3Jvb20gdXNlLiIsCiAgInN0YXJ0X3VybCI6ICIuL2luZGV4Lmh0bWwiLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmYWY4ZjUiLAogICJ0aGVtZV9jb2xvciI6ICIjMWUyOTNiIiwKICAib3JpZW50YXRpb24iOiAicG9ydHJhaXQiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzE5MicgaGVpZ2h0PScxOTInIHZpZXdCb3g9JzAgMCAxOTIgMTkyJyUzRSUzQ3JlY3QgZmlsbD0nJTIzMWUyOTNiJyB3aWR0aD0nMTkyJyBoZWlnaHQ9JzE5Micgcng9JzI0Jy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1mYW1pbHk9J3NlcmlmJyBmb250LXNpemU9JzgwJyBmaWxsPSclMjNmZmYnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnJTNFJUYwJTlGJTkzJTlBJTNDL3RleHQlM0UlM0Mvc3ZnJTNFIiwKICAgICAgInNpemVzIjogIjE5MngxOTIiLAogICAgICAidHlwZSI6ICJpbWFnZS9zdmcreG1sIgogICAgfSwKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnIHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2Zycgd2lkdGg9JzUxMicgaGVpZ2h0PSc1MTInIHZpZXdCb3g9JzAgMCA1MTIgNTEyJyUzRSUzQ3JlY3QgZmlsbD0nJTIzMWUyOTNiJyB3aWR0aD0nNTEyJyBoZWlnaHQ9JzUxMicgcng9JzY0Jy8lM0UlM0N0ZXh0IHg9JzUwJTI1JyB5PSc1MCUyNScgZm9udC1mYW1pbHk9J3NlcmlmJyBmb250LXNpemU9JzI0MCcgZmlsbD0nJTIzZmZmJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkb21pbmFudC1iYXNlbGluZT0nbWlkZGxlJyUzRSVGMCU5RiU5MyU5QSUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Case Builder">

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg: #faf8f5;
  --bg-card: #ffffff;
  --text: #1e293b;
  --text-muted: #64748b;
  --text-light: #94a3b8;
  --accent: #4a6fa5;
  --accent-light: #e8eef6;
  --accent-hover: #3b5d8f;
  --gold: #b8860b;
  --gold-light: #f5e6c8;
  --border: #e2e0db;
  --border-light: #f0eee9;
  --danger: #b91c1c;
  --danger-light: #fef2f2;
  --success: #15803d;
  --success-light: #dcfce7;
  --warning: #ca8a04;
  --warning-light: #fef3c7;
  --info: #0284c7;
  --info-light: #e0f2fe;
  --radius: 8px;
  --radius-sm: 6px;
  --radius-lg: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 4px 12px rgba(0,0,0,0.04);
  --shadow-lg: 0 4px 16px rgba(0,0,0,0.08), 0 12px 40px rgba(0,0,0,0.06);
  --shadow-xl: 0 10px 25px rgba(0,0,0,0.1), 0 20px 48px rgba(0,0,0,0.08);
  --font-serif: 'Crimson Pro', Georgia, serif;
  --font-sans: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
  --max-w: 720px;
  --transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
  --transition-slow: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@media (prefers-color-scheme: dark) {
  :root {
    --bg: #0f172a;
    --bg-card: #1e293b;
    --text: #f1f5f9;
    --text-muted: #94a3b8;
    --text-light: #64748b;
    --accent: #60a5fa;
    --accent-light: #1e3a5f;
    --accent-hover: #93c5fd;
    --gold: #fbbf24;
    --gold-light: #422006;
    --border: #334155;
    --border-light: #1e293b;
    --danger-light: #450a0a;
    --success-light: #14532d;
    --warning-light: #422006;
    --info-light: #0c4a6e;
  }
  .student-note-prompt-text {
    color: #e2e8f0; /* Light gray text for dark mode */
  }
  .student-note {
    background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
  }
  .tooltip,
  .field-help .help-tooltip {
    background: #1e293b;
    color: #f1f5f9;
  }
  .field-help .help-tooltip::after {
    border-top-color: #1e293b;
  }
}

html { font-size: 16px; scroll-behavior: smooth; }

body {
  font-family: var(--font-sans);
  background: var(--bg);
  color: var(--text);
  line-height: 1.65;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
.app-header {
  background: var(--text);
  color: #fff;
  padding: 1.25rem 1.5rem;
  position: sticky;
  top: 0;
  z-index: 100;
}
.app-header-inner {
  max-width: var(--max-w);
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
}
.app-title {
  font-family: var(--font-serif);
  font-size: 1.35rem;
  font-weight: 700;
  letter-spacing: -0.01em;
}
.app-subtitle {
  font-size: 0.78rem;
  opacity: 0.6;
  margin-top: 2px;
}
.header-badge {
  font-size: 0.68rem;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  background: rgba(255,255,255,0.12);
  padding: 4px 10px;
  border-radius: 20px;
  white-space: nowrap;
}
.header-actions {
  display: flex;
  align-items: center;
  gap: 0.75rem;
}
.icon-btn {
  background: none;
  border: none;
  color: rgba(255,255,255,0.8);
  cursor: pointer;
  font-size: 1.1rem;
  padding: 0.4rem;
  border-radius: 6px;
  transition: all var(--transition);
  position: relative;
  line-height: 1;
}
.icon-btn:hover {
  background: rgba(255,255,255,0.15);
  color: #fff;
}
.icon-btn .badge {
  position: absolute;
  top: -4px;
  right: -4px;
  background: var(--danger);
  color: #fff;
  font-size: 0.65rem;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 600;
}
.tooltip {
  position: absolute;
  background: var(--text);
  color: #fff;
  padding: 0.4rem 0.65rem;
  border-radius: 6px;
  font-size: 0.75rem;
  white-space: nowrap;
  pointer-events: none;
  opacity: 0;
  transition: opacity var(--transition);
  z-index: 1001;
  box-shadow: var(--shadow-lg);
}
.icon-btn:hover .tooltip {
  opacity: 1;
}

/* ‚îÄ‚îÄ Progress ‚îÄ‚îÄ */
.progress-wrap {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 1.5rem 1.5rem 0;
}
.progress-label {
  display: flex;
  justify-content: space-between;
  font-size: 0.78rem;
  color: var(--text-muted);
  margin-bottom: 0.5rem;
  font-weight: 500;
}
.progress-track {
  height: 6px;
  background: var(--border);
  border-radius: 3px;
  overflow: hidden;
}
.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--accent), var(--gold));
  border-radius: 3px;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  width: 0%;
}

/* ‚îÄ‚îÄ Step indicators ‚îÄ‚îÄ */
.step-dots {
  display: flex;
  justify-content: center;
  gap: 0.5rem;
  margin-top: 1rem;
}
.step-dot {
  width: 8px; height: 8px;
  border-radius: 50%;
  background: var(--border);
  transition: all var(--transition);
  cursor: pointer;
}
.step-dot.active { background: var(--accent); transform: scale(1.3); }
.step-dot.done { background: var(--gold); }

/* ‚îÄ‚îÄ Main container ‚îÄ‚îÄ */
.main {
  max-width: var(--max-w);
  margin: 0 auto;
  padding: 1.5rem;
  min-height: calc(100vh - 200px);
}

/* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
.card {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 2rem;
  animation: cardIn 0.35s ease-out;
}
@keyframes cardIn {
  from { opacity: 0; transform: translateY(12px); }
  to { opacity: 1; transform: translateY(0); }
}
.card-header {
  margin-bottom: 1.75rem;
  padding-bottom: 1.25rem;
  border-bottom: 1px solid var(--border-light);
}
.card-step-label {
  font-size: 0.72rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--accent);
  font-weight: 600;
  margin-bottom: 0.4rem;
}
.card-title {
  font-family: var(--font-serif);
  font-size: 1.55rem;
  font-weight: 700;
  line-height: 1.3;
  color: var(--text);
}
.card-hint {
  margin-top: 0.6rem;
  font-size: 0.88rem;
  color: var(--text-muted);
  line-height: 1.55;
}

/* ‚îÄ‚îÄ Form elements ‚îÄ‚îÄ */
.field { margin-bottom: 1.25rem; }
.field:last-child { margin-bottom: 0; }
.field label {
  display: block;
  font-size: 0.82rem;
  font-weight: 600;
  color: var(--text);
  margin-bottom: 0.35rem;
}
input[type="text"], input[type="number"], select, textarea {
  width: 100%;
  font-family: var(--font-sans);
  font-size: 0.92rem;
  color: var(--text);
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 0.6rem 0.75rem;
  transition: border-color var(--transition), box-shadow var(--transition);
  line-height: 1.5;
}
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.12);
}
textarea { resize: vertical; min-height: 80px; }
select { cursor: pointer; }

.radio-group {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.25rem;
}
.radio-pill {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.85rem;
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 0.82rem;
  cursor: pointer;
  transition: all var(--transition);
  background: var(--bg);
  user-select: none;
}
.radio-pill:hover { border-color: var(--accent); background: var(--accent-light); }
.radio-pill input { display: none; }
.radio-pill.selected {
  background: var(--accent);
  color: #fff;
  border-color: var(--accent);
}

/* ‚îÄ‚îÄ Dynamic list (stakeholders, options) ‚îÄ‚îÄ */
.dynamic-list { display: flex; flex-direction: column; gap: 0.75rem; }
.dynamic-item {
  background: var(--bg);
  border: 1px solid var(--border-light);
  border-radius: 6px;
  padding: 1rem;
  position: relative;
  animation: cardIn 0.25s ease-out;
}
.dynamic-item .item-num {
  font-family: var(--font-serif);
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 0.5rem;
}
.dynamic-item .remove-btn {
  position: absolute;
  top: 0.6rem; right: 0.6rem;
  background: none;
  border: none;
  color: var(--text-light);
  cursor: pointer;
  font-size: 1.1rem;
  line-height: 1;
  padding: 2px 6px;
  border-radius: 4px;
  transition: all var(--transition);
}
.dynamic-item .remove-btn:hover { color: var(--danger); background: #fef2f2; }

.add-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  font-family: var(--font-sans);
  font-size: 0.82rem;
  font-weight: 500;
  color: var(--accent);
  background: none;
  border: 1px dashed var(--accent);
  border-radius: 6px;
  padding: 0.5rem 1rem;
  cursor: pointer;
  transition: all var(--transition);
  margin-top: 0.5rem;
}
.add-btn:hover { background: var(--accent-light); }

/* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
.nav-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 1.75rem;
  gap: 1rem;
}
.btn {
  font-family: var(--font-sans);
  font-size: 0.88rem;
  font-weight: 600;
  padding: 0.65rem 1.5rem;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  transition: all var(--transition);
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
}
.btn-primary {
  background: var(--accent);
  color: #fff;
}
.btn-primary:hover { background: var(--accent-hover); transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-secondary {
  background: transparent;
  color: var(--text-muted);
  border: 1px solid var(--border);
}
.btn-secondary:hover { background: var(--bg); color: var(--text); border-color: var(--text-light); }
.btn-gold {
  background: var(--gold);
  color: #fff;
}
.btn-gold:hover { background: #9a7209; transform: translateY(-1px); box-shadow: var(--shadow); }
.btn-danger {
  background: transparent;
  color: var(--danger);
  border: 1px solid #fecaca;
}
.btn-danger:hover { background: #fef2f2; }
.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
}

/* ‚îÄ‚îÄ Result view ‚îÄ‚îÄ */
.result-wrap {
  animation: cardIn 0.4s ease-out;
}
.result-actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.6rem;
  margin-bottom: 1.5rem;
}
.result-content {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 2.5rem;
  box-shadow: var(--shadow);
  font-family: var(--font-serif);
  font-size: 1.02rem;
  line-height: 1.8;
  color: #2d3748;
  max-height: 70vh;
  overflow-y: auto;
}
.result-content h1 {
  font-size: 1.65rem;
  font-weight: 700;
  margin-bottom: 0.25rem;
  line-height: 1.3;
  color: var(--text);
}
.result-content .case-meta {
  font-family: var(--font-sans);
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-bottom: 2rem;
  padding-bottom: 1.25rem;
  border-bottom: 2px solid var(--border-light);
}
.result-content h2 {
  font-size: 1.2rem;
  font-weight: 700;
  color: var(--accent);
  margin-top: 2rem;
  margin-bottom: 0.6rem;
  padding-bottom: 0.3rem;
  border-bottom: 1px solid var(--border-light);
}
.result-content p { margin-bottom: 0.85rem; }
.result-content ul, .result-content ol {
  margin: 0.5rem 0 1rem 1.5rem;
}
.result-content li { margin-bottom: 0.4rem; }
.result-content strong { color: var(--text); }
.result-content .discussion-q {
  background: var(--accent-light);
  border-left: 3px solid var(--accent);
  padding: 0.75rem 1rem;
  margin-bottom: 0.5rem;
  border-radius: 0 6px 6px 0;
  font-style: italic;
}

/* ‚îÄ‚îÄ Toast ‚îÄ‚îÄ */
.toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--text);
  color: #fff;
  padding: 0.65rem 1.25rem;
  border-radius: 8px;
  font-size: 0.85rem;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  transition: transform 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 1000;
  pointer-events: none;
}
.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--success); }
.toast.error { background: var(--danger); }
.toast.warning { background: var(--warning); }
.toast.info { background: var(--info); }

/* ‚îÄ‚îÄ Modal ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  backdrop-filter: blur(4px);
  z-index: 999;
  display: none;
  align-items: center;
  justify-content: center;
  padding: 1rem;
  opacity: 0;
  transition: opacity var(--transition);
}
.modal-overlay.show {
  display: flex;
  opacity: 1;
}
.modal {
  background: var(--bg-card);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  max-width: 600px;
  width: 100%;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transform: scale(0.95) translateY(20px);
  transition: transform var(--transition);
}
.modal-overlay.show .modal {
  transform: scale(1) translateY(0);
}
.modal-header {
  padding: 1.25rem 1.5rem;
  border-bottom: 1px solid var(--border);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-title {
  font-family: var(--font-serif);
  font-size: 1.25rem;
  font-weight: 700;
  color: var(--text);
}
.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--text-light);
  cursor: pointer;
  padding: 0.25rem;
  line-height: 1;
  border-radius: 4px;
  transition: all var(--transition);
}
.modal-close:hover {
  background: var(--border-light);
  color: var(--text);
}
.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
}
.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid var(--border);
  display: flex;
  gap: 0.75rem;
  justify-content: flex-end;
}

/* ‚îÄ‚îÄ Saved Cases List ‚îÄ‚îÄ */
.saved-case-item {
  background: var(--bg);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 1rem;
  margin-bottom: 0.75rem;
  transition: all var(--transition);
  cursor: pointer;
}
.saved-case-item:hover {
  border-color: var(--accent);
  box-shadow: var(--shadow);
  transform: translateY(-1px);
}
.saved-case-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 0.5rem;
}
.saved-case-title {
  font-weight: 600;
  color: var(--text);
  font-size: 0.95rem;
  margin-bottom: 0.25rem;
}
.saved-case-meta {
  font-size: 0.75rem;
  color: var(--text-muted);
}
.saved-case-actions {
  display: flex;
  gap: 0.25rem;
}
.saved-case-actions button {
  background: none;
  border: none;
  padding: 0.25rem 0.5rem;
  cursor: pointer;
  border-radius: 4px;
  font-size: 0.85rem;
  color: var(--text-light);
  transition: all var(--transition);
}
.saved-case-actions button:hover {
  background: var(--border-light);
  color: var(--text);
}
.saved-case-actions button.delete:hover {
  background: var(--danger-light);
  color: var(--danger);
}
.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}
.empty-state-icon {
  font-size: 3rem;
  margin-bottom: 1rem;
  opacity: 0.5;
}
.empty-state-text {
  font-size: 0.9rem;
}

/* ‚îÄ‚îÄ Auto-save indicator ‚îÄ‚îÄ */
.auto-save-indicator {
  position: fixed;
  top: 5rem;
  right: 1rem;
  background: var(--success);
  color: #fff;
  padding: 0.5rem 0.85rem;
  border-radius: 20px;
  font-size: 0.75rem;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition);
  z-index: 100;
}
.auto-save-indicator.show {
  opacity: 1;
}
.auto-save-indicator.saving {
  background: var(--info);
}

/* ‚îÄ‚îÄ Field validation ‚îÄ‚îÄ */
.field.error input,
.field.error textarea,
.field.error select {
  border-color: var(--danger);
}
.field.error .error-message {
  display: block;
}
.error-message {
  display: none;
  color: var(--danger);
  font-size: 0.75rem;
  margin-top: 0.25rem;
}

/* ‚îÄ‚îÄ Help tooltips ‚îÄ‚îÄ */
.field-help {
  display: inline-block;
  width: 16px;
  height: 16px;
  line-height: 16px;
  text-align: center;
  background: var(--border);
  color: var(--text-muted);
  border-radius: 50%;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 0.25rem;
  cursor: help;
  position: relative;
}
.field-help:hover {
  background: var(--accent);
  color: #fff;
}
.field-help .help-tooltip {
  position: absolute;
  bottom: calc(100% + 8px);
  left: 50%;
  transform: translateX(-50%);
  background: var(--text);
  color: #fff;
  padding: 0.5rem 0.75rem;
  border-radius: 6px;
  font-size: 0.75rem;
  font-weight: 400;
  white-space: normal;
  width: 220px;
  text-align: left;
  box-shadow: var(--shadow-lg);
  opacity: 0;
  pointer-events: none;
  transition: opacity var(--transition);
  z-index: 1001;
}
.field-help:hover .help-tooltip,
.field-help.active .help-tooltip {
  opacity: 1;
}
.field-help .help-tooltip::after {
  content: '';
  position: absolute;
  top: 100%;
  left: 50%;
  transform: translateX(-50%);
  border: 6px solid transparent;
  border-top-color: var(--text);
}

/* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
.app-footer {
  max-width: var(--max-w);
  margin: 3rem auto 0;
  padding: 1.5rem;
  text-align: center;
  border-top: 1px solid var(--border-light);
}
.app-footer p {
  font-size: 0.78rem;
  color: var(--text-light);
  line-height: 1.6;
}
.app-footer a {
  color: var(--accent);
  text-decoration: none;
}
.app-footer a:hover { text-decoration: underline; }

/* ‚îÄ‚îÄ Student Note ‚îÄ‚îÄ */
.student-note {
  max-width: var(--max-w);
  margin: 3rem auto 1rem;
  padding: 1.5rem;
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-left: 4px solid var(--accent);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  display: none;
}
.student-note-header {
  font-size: 1.1rem;
  font-weight: 700;
  color: var(--text);
  margin-bottom: 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}
.student-note-icon {
  font-size: 1.3rem;
}
.student-note-link {
  color: var(--accent);
  text-decoration: none;
}
.student-note-link:hover {
  text-decoration: underline;
}
.student-note-content {
  font-size: 0.9rem;
  color: var(--text);
  line-height: 1.7;
  margin-bottom: 1rem;
}
.student-note-prompt {
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: 6px;
  padding: 1rem;
  margin-top: 1rem;
  position: relative;
}
.student-note-prompt-header {
  font-size: 0.85rem;
  font-weight: 600;
  color: var(--text-light);
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.student-note-prompt-text {
  font-family: 'Courier New', Courier, monospace;
  font-size: 0.85rem;
  color: var(--text);
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-height: 300px;
  overflow-y: auto;
  padding-right: 0.5rem;
}
.student-note-prompt-copy {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  padding: 0.4rem 0.8rem;
  font-size: 0.8rem;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
}
.student-note-prompt-copy:hover {
  background: var(--accent-dark);
  transform: translateY(-1px);
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}
.student-note-prompt-copy:active {
  transform: translateY(0);
}

/* ‚îÄ‚îÄ Print styles ‚îÄ‚îÄ */
@media print {
  .app-header, .progress-wrap, .nav-row, .result-actions, .app-footer, .step-dots, .student-note { display: none !important; }
  .main { padding: 0; }
  .result-content {
    max-height: none;
    overflow: visible;
    border: none;
    box-shadow: none;
    padding: 0;
    font-size: 11pt;
  }
  .result-content h1 { font-size: 18pt; }
  .result-content h2 { font-size: 14pt; page-break-after: avoid; }
  .result-content .discussion-q { background: #f0f0f0 !important; -webkit-print-color-adjust: exact; }
}

/* ‚îÄ‚îÄ Responsive ‚îÄ‚îÄ */
@media (max-width: 600px) {
  .card { padding: 1.25rem; }
  .card-title { font-size: 1.3rem; }
  .result-content { padding: 1.25rem; font-size: 0.95rem; }
  .result-actions { flex-direction: column; }
  .result-actions .btn { width: 100%; justify-content: center; }
  .nav-row { flex-direction: column-reverse; }
  .nav-row .btn { width: 100%; justify-content: center; }
  .app-header-inner { flex-direction: column; align-items: flex-start; }
}
</style>
</head>
<body>

<!-- Header -->
<header class="app-header">
  <div class="app-header-inner">
    <div>
      <div class="app-title">Case Study Builder</div>
      <div class="app-subtitle">Management Teaching Tool</div>
    </div>
    <div class="header-actions">
      <button class="icon-btn" onclick="toggleSavedCases()" title="Saved Cases" aria-label="View saved cases">
        üìö
        <span id="savedCountBadge" class="badge" style="display:none;">0</span>
      </button>
      <button class="icon-btn" onclick="saveCurrentCase()" title="Save Progress" aria-label="Save current case">
        üíæ
      </button>
      <div class="header-badge">Offline PWA</div>
    </div>
  </div>
</header>

<!-- Progress -->
<div class="progress-wrap" id="progressWrap">
  <div class="progress-label">
    <span id="stepLabel">Step 1 of 6</span>
    <span id="stepName">Case Context</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill"></div>
  </div>
  <div class="step-dots" id="stepDots"></div>
</div>

<!-- Main -->
<main class="main" id="app"></main>

<!-- Student Note on AI Enhancement (link to separate help page) -->
<section class="student-note" id="studentNote">
  <div class="student-note-header">
    <span class="student-note-icon">‚ú®</span>
    <a href="help.html" target="_blank" rel="noopener" class="student-note-link">How to Improve the Case Study</a>
  </div>
</section>

<!-- Footer -->
<footer class="app-footer">
  <p>
    <strong>Case Study Builder</strong> is a teaching tool for management classes.<br>
    All data stays in your browser. Nothing is sent to any server.<br>
    Conceptualized by <a href="https://www.linkedin.com/in/beingbabu/" target="_blank" rel="noopener">Professor Babu George</a>.
  </p>
</footer>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Auto-save indicator -->
<div class="auto-save-indicator" id="autoSaveIndicator">
  <span id="autoSaveText">‚úì Saved</span>
</div>

<!-- Modal for saved cases -->
<div class="modal-overlay" id="savedCasesModal" onclick="if(event.target===this) toggleSavedCases()">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title">Saved Case Studies</h2>
      <button class="modal-close" onclick="toggleSavedCases()" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body" id="savedCasesList">
      <!-- Populated by JavaScript -->
    </div>
  </div>
</div>

<script>
(function() {
  'use strict';

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  const STEPS = [
    { key: 'context', label: 'Case Context' },
    { key: 'decision_maker', label: 'Key Decision Maker' },
    { key: 'problem', label: 'Problem or Opportunity' },
    { key: 'stakeholders', label: 'Stakeholders' },
    { key: 'options', label: 'Available Options' },
    { key: 'constraints', label: 'Constraints & Data' }
  ];

  let currentStep = 0;
  let showingResult = false;
  let autoSaveTimeout = null;
  let currentCaseId = null;

  const data = {
    title: '', industry: '', company: '', region: '', year: new Date().getFullYear().toString(),
    role: '', decisionMakerName: '', experience: '', background: '',
    problem: '', problemType: '',
    stakeholders: [{ name: '', interest: '' }],
    options: [{ title: '', description: '', implication: '' }, { title: '', description: '', implication: '' }],
    budget: '', timeline: '', ethicalConstraints: ''
  };

  const $ = id => document.getElementById(id);
  const app = $('app');

  // ‚îÄ‚îÄ LocalStorage helpers ‚îÄ‚îÄ
  const STORAGE_KEY = 'caseStudyBuilder';
  const AUTOSAVE_KEY = 'caseStudyBuilder_autosave';
  const CASES_KEY = 'caseStudyBuilder_savedCases';

  function loadSavedCases() {
    try {
      const saved = localStorage.getItem(CASES_KEY);
      return saved ? JSON.parse(saved) : [];
    } catch (e) {
      console.error('Error loading saved cases:', e);
      return [];
    }
  }

  function saveCases(cases) {
    try {
      localStorage.setItem(CASES_KEY, JSON.stringify(cases));
      updateSavedCasesBadge();
    } catch (e) {
      console.error('Error saving cases:', e);
      showToast('Error saving case', 'error');
    }
  }

  function loadAutoSave() {
    try {
      const saved = localStorage.getItem(AUTOSAVE_KEY);
      if (saved) {
        const parsed = JSON.parse(saved);
        Object.assign(data, parsed.data);
        currentStep = parsed.currentStep || 0;
        currentCaseId = parsed.caseId || null;
        return true;
      }
    } catch (e) {
      console.error('Error loading autosave:', e);
    }
    return false;
  }

  function autoSave() {
    clearTimeout(autoSaveTimeout);
    autoSaveTimeout = setTimeout(() => {
      try {
        const saveData = {
          data: { ...data },
          currentStep,
          caseId: currentCaseId,
          timestamp: Date.now()
        };
        localStorage.setItem(AUTOSAVE_KEY, JSON.stringify(saveData));
        showAutoSaveIndicator();
      } catch (e) {
        console.error('Error auto-saving:', e);
      }
    }, 1000);
  }
  
  // Make autoSave available globally
  window.autoSave = autoSave;

  function showAutoSaveIndicator(saving = false) {
    const indicator = $('autoSaveIndicator');
    const text = $('autoSaveText');
    indicator.classList.remove('saving');
    if (saving) {
      indicator.classList.add('saving');
      text.textContent = 'üíæ Saving...';
    } else {
      text.textContent = '‚úì Saved';
    }
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 2000);
  }

  function updateSavedCasesBadge() {
    const cases = loadSavedCases();
    const badge = $('savedCountBadge');
    if (cases.length > 0) {
      badge.textContent = cases.length;
      badge.style.display = 'flex';
    } else {
      badge.style.display = 'none';
    }
  }

  // ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
  function showToast(msg, type = 'default') {
    const t = $('toast');
    t.textContent = msg;
    t.className = 'toast';
    if (type !== 'default') t.classList.add(type);
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 2200);
  }

  // ‚îÄ‚îÄ Progress ‚îÄ‚îÄ
  function updateProgress() {
    if (showingResult) {
      $('progressWrap').style.display = 'none';
      return;
    }
    $('progressWrap').style.display = '';
    const pct = ((currentStep + 1) / STEPS.length) * 100;
    $('progressFill').style.width = pct + '%';
    $('stepLabel').textContent = `Step ${currentStep + 1} of ${STEPS.length}`;
    $('stepName').textContent = STEPS[currentStep].label;

    const dots = $('stepDots');
    dots.innerHTML = '';
    STEPS.forEach((s, i) => {
      const d = document.createElement('div');
      d.className = 'step-dot' + (i === currentStep ? ' active' : '') + (i < currentStep ? ' done' : '');
      d.title = s.label;
      d.addEventListener('click', () => { if (i < currentStep) { saveCurrentStep(); currentStep = i; render(); } });
      dots.appendChild(d);
    });
  }

  // ‚îÄ‚îÄ Save inputs from DOM into data ‚îÄ‚îÄ
  function saveCurrentStep() {
    switch (currentStep) {
      case 0:
        data.title = v('f-title');
        data.industry = v('f-industry');
        data.company = v('f-company');
        data.region = v('f-region');
        data.year = v('f-year');
        break;
      case 1:
        data.decisionMakerName = v('f-name');
        data.role = v('f-role');
        data.experience = v('f-exp');
        data.background = v('f-bg');
        break;
      case 2:
        data.problem = v('f-problem');
        const sel = document.querySelector('.radio-pill.selected input');
        data.problemType = sel ? sel.value : '';
        break;
      case 3:
        data.stakeholders = [];
        document.querySelectorAll('.sh-item').forEach(el => {
          const name = el.querySelector('.sh-name')?.value?.trim() || '';
          const interest = el.querySelector('.sh-interest')?.value?.trim() || '';
          if (name) data.stakeholders.push({ name, interest });
        });
        if (data.stakeholders.length === 0) data.stakeholders.push({ name: '', interest: '' });
        break;
      case 4:
        data.options = [];
        document.querySelectorAll('.opt-item').forEach(el => {
          const title = el.querySelector('.opt-title')?.value?.trim() || '';
          const desc = el.querySelector('.opt-desc')?.value?.trim() || '';
          const imp = el.querySelector('.opt-imp')?.value?.trim() || '';
          if (title) data.options.push({ title, description: desc, implication: imp });
        });
        if (data.options.length < 2) {
          while (data.options.length < 2) data.options.push({ title: '', description: '', implication: '' });
        }
        break;
      case 5:
        data.budget = v('f-budget');
        data.timeline = v('f-timeline');
        data.ethicalConstraints = v('f-ethics');
        break;
    }
    autoSave();
  }

  function v(id) { const el = document.getElementById(id); return el ? el.value.trim() : ''; }

  // ‚îÄ‚îÄ Saved Cases Management ‚îÄ‚îÄ
  window.saveCurrentCase = function() {
    saveCurrentStep();
    
    const caseName = data.title || 'Untitled Case Study';
    const cases = loadSavedCases();
    
    if (currentCaseId) {
      // Update existing case
      const idx = cases.findIndex(c => c.id === currentCaseId);
      if (idx !== -1) {
        cases[idx] = {
          id: currentCaseId,
          name: caseName,
          data: { ...data },
          currentStep,
          savedAt: Date.now()
        };
        showToast('Case updated successfully!', 'success');
      }
    } else {
      // Save as new case
      currentCaseId = 'case_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
      cases.push({
        id: currentCaseId,
        name: caseName,
        data: { ...data },
        currentStep,
        savedAt: Date.now()
      });
      showToast('Case saved successfully!', 'success');
    }
    
    saveCases(cases);
  };

  window.toggleSavedCases = function() {
    const modal = $('savedCasesModal');
    const isShown = modal.classList.contains('show');
    
    if (isShown) {
      modal.classList.remove('show');
    } else {
      renderSavedCases();
      modal.classList.add('show');
    }
  };

  function renderSavedCases() {
    const cases = loadSavedCases().sort((a, b) => b.savedAt - a.savedAt);
    const container = $('savedCasesList');
    
    if (cases.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìö</div>
          <div class="empty-state-text">No saved cases yet.<br>Save your progress to access it later!</div>
        </div>`;
      return;
    }
    
    let html = '';
    cases.forEach(c => {
      const date = new Date(c.savedAt).toLocaleString();
      const isCurrent = c.id === currentCaseId;
      html += `
        <div class="saved-case-item" onclick="loadCase('${c.id}')">
          <div class="saved-case-header">
            <div>
              <div class="saved-case-title">${esc(c.name)}${isCurrent ? ' <span style="color:var(--accent);font-size:0.8rem;">(Current)</span>' : ''}</div>
              <div class="saved-case-meta">
                ${c.data.industry || 'No industry'} ¬∑ ${c.data.region || 'No region'} ¬∑ Saved ${date}
              </div>
            </div>
            <div class="saved-case-actions" onclick="event.stopPropagation()">
              <button onclick="loadCase('${c.id}')" title="Load">üìÇ</button>
              <button onclick="duplicateCase('${c.id}')" title="Duplicate">üìã</button>
              <button class="delete" onclick="deleteCase('${c.id}')" title="Delete">üóëÔ∏è</button>
            </div>
          </div>
        </div>`;
    });
    
    container.innerHTML = html;
  }

  window.loadCase = function(caseId) {
    const cases = loadSavedCases();
    const caseData = cases.find(c => c.id === caseId);
    
    if (!caseData) {
      showToast('Case not found', 'error');
      return;
    }
    
    if (confirm(`Load "${caseData.name}"? Any unsaved changes will be lost.`)) {
      Object.assign(data, caseData.data);
      currentStep = caseData.currentStep || 0;
      currentCaseId = caseId;
      showingResult = false;
      toggleSavedCases();
      render();
      showToast('Case loaded!', 'success');
      window.scrollTo(0, 0);
    }
  };

  window.duplicateCase = function(caseId) {
    const cases = loadSavedCases();
    const caseData = cases.find(c => c.id === caseId);
    
    if (!caseData) {
      showToast('Case not found', 'error');
      return;
    }
    
    const newId = 'case_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    const newCase = {
      id: newId,
      name: caseData.name + ' (Copy)',
      data: { ...caseData.data },
      currentStep: caseData.currentStep,
      savedAt: Date.now()
    };
    
    cases.push(newCase);
    saveCases(cases);
    renderSavedCases();
    showToast('Case duplicated!', 'success');
  };

  window.deleteCase = function(caseId) {
    if (!confirm('Delete this case? This cannot be undone.')) return;
    
    let cases = loadSavedCases();
    cases = cases.filter(c => c.id !== caseId);
    saveCases(cases);
    
    if (currentCaseId === caseId) {
      currentCaseId = null;
    }
    
    renderSavedCases();
    showToast('Case deleted', 'info');
  };

  // ‚îÄ‚îÄ Render ‚îÄ‚îÄ
  function render() {
    updateProgress();
    $('studentNote').style.display = showingResult ? 'block' : 'none';
    if (showingResult) return renderResult();

    let html = '<div class="card">';
    html += `<div class="card-header">
      <div class="card-step-label">Step ${currentStep + 1} of ${STEPS.length}</div>
      <div class="card-title">${STEPS[currentStep].label}</div>`;

    switch (currentStep) {
      case 0:
        html += `<div class="card-hint">Set the scene for your case study. Where and when does it take place?</div></div>`;
        html += field('Title', 'f-title', 'text', data.title, 'e.g., "Digital Transformation at Acme Corp"', 'A compelling title that captures the essence of the case');
        html += fieldSelect('Industry', 'f-industry', data.industry, ['','Technology','Healthcare','Finance','Retail','Manufacturing','Education','Energy','Hospitality','Transportation','Other'], 'Select the primary industry sector');
        html += field('Company Name', 'f-company', 'text', data.company, 'Real or fictional', 'Use a real company or create a fictional one');
        html += field('Country or Region', 'f-region', 'text', data.region, 'e.g., United States, Southeast Asia', 'Geographic context helps students understand cultural and regulatory factors');
        html += field('Year', 'f-year', 'text', data.year, 'e.g., 2024 or "current year"', 'Temporal context is important for technological and market conditions');
        break;

      case 1:
        html += `<div class="card-hint">Who is the protagonist? Describe the person facing the decision.</div></div>`;
        html += field('Name', 'f-name', 'text', data.decisionMakerName, 'e.g., Jane Smith', 'The decision-maker\'s name');
        html += field('Role / Title', 'f-role', 'text', data.role, 'e.g., CEO, Department Head, Project Manager', 'The decision-maker\'s position influences their perspective and authority');
        html += field('Years of Experience', 'f-exp', 'number', data.experience, 'Approximate number', 'Experience level affects credibility and decision-making approach');
        html += fieldTextarea('Previous Background', 'f-bg', data.background, 'Briefly describe their career path or relevant expertise (2-3 sentences).', 3, 'Background provides context for their expertise and potential biases');
        break;

      case 2:
        html += `<div class="card-hint">What challenge or opportunity does the decision maker face? Be specific.</div></div>`;
        html += fieldTextarea('Situation Description', 'f-problem', data.problem, 'Describe the core problem or opportunity in 2-3 sentences.', 4, 'Be specific about the challenge. What decision needs to be made and why?');
        html += `<div class="field"><label>Category <span class="field-help">?<span class="help-tooltip">Categorizing helps students identify relevant frameworks and analysis methods</span></span></label>`;
        html += radioGroup('problemType', ['Strategic','Operational','Leadership / HR','Ethics','Risk / Finance'], data.problemType);
        html += `</div>`;
        break;

      case 3:
        html += `<div class="card-hint">Who has a stake in this decision? Think about employees, customers, investors, regulators, and others.</div></div>`;
        html += `<div class="dynamic-list" id="sh-list">`;
        data.stakeholders.forEach((s, i) => {
          html += stakeholderItem(i, s);
        });
        html += `</div>`;
        html += `<button class="add-btn" onclick="addStakeholder()">+ Add Stakeholder</button>`;
        break;

      case 4:
        html += `<div class="card-hint">List 2 to 4 courses of action the decision maker could pursue. Include a short description and one sentence on the likely consequence of each.</div></div>`;
        html += `<div class="dynamic-list" id="opt-list">`;
        data.options.forEach((o, i) => {
          html += optionItem(i, o);
        });
        html += `</div>`;
        if (data.options.length < 4) {
          html += `<button class="add-btn" onclick="addOption()">+ Add Option</button>`;
        }
        break;

      case 5:
        html += `<div class="card-hint">What real-world constraints does the decision maker face? These make the case more realistic and thought-provoking.</div></div>`;
        html += fieldTextarea('Budget Limitations', 'f-budget', data.budget, 'e.g., "$500K allocated for this initiative"', 2, 'Financial constraints that limit what the decision maker can do');
        html += fieldTextarea('Time Constraints', 'f-timeline', data.timeline, 'e.g., "Decision needed within 3 months"', 2, 'Deadlines or time pressures that affect the decision');
        html += fieldTextarea('Ethical or Regulatory Constraints', 'f-ethics', data.ethicalConstraints, 'e.g., "GDPR compliance required; union agreements in place"', 3, 'Legal, ethical, or regulatory boundaries that must be respected');
        break;
    }

    // Navigation
    html += `<div class="nav-row">`;
    if (currentStep > 0) {
      html += `<button class="btn btn-secondary" onclick="goBack()">&#8592; Back</button>`;
    } else {
      html += `<div></div>`;
    }
    if (currentStep < STEPS.length - 1) {
      html += `<button class="btn btn-primary" onclick="goNext()">Next &#8594;</button>`;
    } else {
      html += `<button class="btn btn-gold" onclick="generate()">&#9733; Generate Case Study</button>`;
    }
    html += `</div></div>`;

    app.innerHTML = html;
    initRadioPills();
  }

  // ‚îÄ‚îÄ Field helpers ‚îÄ‚îÄ
  function field(label, id, type, val, placeholder, helpText) {
    const help = helpText ? `<span class="field-help">?<span class="help-tooltip">${esc(helpText)}</span></span>` : '';
    return `<div class="field"><label for="${id}">${label}${help}</label>
      <input type="${type}" id="${id}" value="${esc(val)}" placeholder="${esc(placeholder)}" oninput="autoSave()">
      <span class="error-message">This field is required</span></div>`;
  }
  function fieldTextarea(label, id, val, placeholder, rows, helpText) {
    const help = helpText ? `<span class="field-help">?<span class="help-tooltip">${esc(helpText)}</span></span>` : '';
    return `<div class="field"><label for="${id}">${label}${help}</label>
      <textarea id="${id}" rows="${rows}" placeholder="${esc(placeholder)}" oninput="autoSave()">${esc(val)}</textarea>
      <span class="error-message">This field is required</span></div>`;
  }
  function fieldSelect(label, id, val, opts, helpText) {
    const help = helpText ? `<span class="field-help">?<span class="help-tooltip">${esc(helpText)}</span></span>` : '';
    let h = `<div class="field"><label for="${id}">${label}${help}</label><select id="${id}" onchange="autoSave()">`;
    opts.forEach(o => {
      const lab = o || '‚Äî Select ‚Äî';
      h += `<option value="${esc(o)}"${o === val ? ' selected' : ''}>${lab}</option>`;
    });
    return h + `</select></div>`;
  }
  function radioGroup(name, options, selected) {
    let h = `<div class="radio-group">`;
    options.forEach(o => {
      const s = o === selected ? ' selected' : '';
      h += `<label class="radio-pill${s}" onclick="toggleRadio(this)">
        <input type="radio" name="${name}" value="${esc(o)}"${s ? ' checked' : ''}>${o}</label>`;
    });
    return h + `</div>`;
  }
  function stakeholderItem(i, s) {
    const rm = data.stakeholders.length > 1 ? `<button class="remove-btn" onclick="removeStakeholder(${i})" title="Remove">&times;</button>` : '';
    return `<div class="dynamic-item sh-item">
      ${rm}<div class="item-num">Stakeholder ${i + 1}</div>
      <div class="field"><label>Name or Group<span class="field-help">?<span class="help-tooltip">Identify a person, group, or entity affected by the decision</span></span></label><input class="sh-name" type="text" value="${esc(s.name)}" placeholder="e.g., Employees, Board of Directors" oninput="autoSave()"></div>
      <div class="field"><label>Interest or Concern<span class="field-help">?<span class="help-tooltip">What does this stakeholder care about most in this situation?</span></span></label><input class="sh-interest" type="text" value="${esc(s.interest)}" placeholder="e.g., Job security, return on investment" oninput="autoSave()"></div>
    </div>`;
  }
  function optionItem(i, o) {
    const rm = data.options.length > 2 ? `<button class="remove-btn" onclick="removeOption(${i})" title="Remove">&times;</button>` : '';
    return `<div class="dynamic-item opt-item">
      ${rm}<div class="item-num">Option ${i + 1}</div>
      <div class="field"><label>Title<span class="field-help">?<span class="help-tooltip">A short name for this course of action</span></span></label><input class="opt-title" type="text" value="${esc(o.title)}" placeholder="e.g., Invest in AI automation" oninput="autoSave()"></div>
      <div class="field"><label>Description<span class="field-help">?<span class="help-tooltip">Explain what this option involves and how it would be implemented</span></span></label><textarea class="opt-desc" rows="2" placeholder="Briefly describe this course of action." oninput="autoSave()">${esc(o.description)}</textarea></div>
      <div class="field"><label>Likely Implication<span class="field-help">?<span class="help-tooltip">What is the expected outcome or consequence of choosing this option?</span></span></label><input class="opt-imp" type="text" value="${esc(o.implication)}" placeholder="One sentence on the expected outcome." oninput="autoSave()"></div>
    </div>`;
  }

  function esc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function initRadioPills() {
    // Already handled via onclick
  }

  // ‚îÄ‚îÄ Global handlers ‚îÄ‚îÄ
  window.toggleRadio = function(el) {
    el.closest('.radio-group').querySelectorAll('.radio-pill').forEach(p => p.classList.remove('selected'));
    el.classList.add('selected');
    el.querySelector('input').checked = true;
  };

  window.goBack = function() { saveCurrentStep(); currentStep--; render(); window.scrollTo(0,0); };
  window.goNext = function() { saveCurrentStep(); currentStep++; render(); window.scrollTo(0,0); };

  window.addStakeholder = function() {
    saveCurrentStep();
    data.stakeholders.push({ name: '', interest: '' });
    render();
  };
  window.removeStakeholder = function(i) {
    saveCurrentStep();
    data.stakeholders.splice(i, 1);
    render();
  };
  window.addOption = function() {
    saveCurrentStep();
    data.options.push({ title: '', description: '', implication: '' });
    render();
  };
  window.removeOption = function(i) {
    saveCurrentStep();
    data.options.splice(i, 1);
    render();
  };

  // ‚îÄ‚îÄ Generate ‚îÄ‚îÄ
  window.generate = function() {
    saveCurrentStep();
    showingResult = true;
    render();
    window.scrollTo(0,0);
  };

  window.startOver = function() {
    if (!confirm('Start over? All your inputs will be cleared.')) return;
    Object.keys(data).forEach(k => {
      if (Array.isArray(data[k])) {
        if (k === 'stakeholders') data[k] = [{ name: '', interest: '' }];
        else if (k === 'options') data[k] = [{ title: '', description: '', implication: '' }, { title: '', description: '', implication: '' }];
      } else {
        data[k] = k === 'year' ? new Date().getFullYear().toString() : '';
      }
    });
    currentStep = 0;
    showingResult = false;
    render();
    window.scrollTo(0,0);
  };

  // ‚îÄ‚îÄ Build case text ‚îÄ‚îÄ
  function buildCaseHTML() {
    const title = data.title || 'Untitled Case Study';
    const yr = data.year || new Date().getFullYear();
    const industry = data.industry || 'Not specified';
    const region = data.region || 'Not specified';
    const company = data.company || 'the organization';
    const companyDisplay = data.company || '[Company]';

    let meta = `${industry} ¬∑ ${region} ¬∑ ${yr}`;
    if (data.company) meta = `${data.company} ¬∑ ` + meta;

    let h = `<h1>${esc(title)}</h1><div class="case-meta">${esc(meta)}</div>`;

    // Company Overview
    h += `<h2>Company Overview</h2>`;
    h += `<p>${esc(companyDisplay)} operates in the <strong>${esc(industry.toLowerCase())}</strong> sector in <strong>${esc(region)}</strong>.`;
    if (data.role) {
      if (data.decisionMakerName) {
        h += ` The case centers on <strong>${esc(data.decisionMakerName)}</strong>, a <strong>${esc(data.role)}</strong>`;
      } else {
        h += ` The case centers on a <strong>${esc(data.role)}</strong>`;
      }
      if (data.experience) h += ` with approximately ${esc(data.experience)} years of professional experience`;
      h += `.`;
    }
    if (data.background) {
      h += ` ${esc(data.background)}`;
    }
    h += `</p>`;

    // Problem
    h += `<h2>Background and ${data.problemType === 'Ethics' ? 'Ethical Dilemma' : 'Problem Statement'}</h2>`;
    if (data.problemType) {
      h += `<p><strong>Category:</strong> ${esc(data.problemType)}</p>`;
    }
    h += `<p>${esc(data.problem || 'No problem description provided.')}</p>`;

    // Stakeholders
    const validSH = data.stakeholders.filter(s => s.name);
    if (validSH.length > 0) {
      h += `<h2>Key Stakeholders</h2><ul>`;
      validSH.forEach(s => {
        h += `<li><strong>${esc(s.name)}</strong>`;
        if (s.interest) h += `: ${esc(s.interest)}`;
        h += `</li>`;
      });
      h += `</ul>`;
    }

    // Options
    const validOpts = data.options.filter(o => o.title);
    if (validOpts.length > 0) {
      h += `<h2>Available Options</h2>`;
      validOpts.forEach((o, i) => {
        h += `<p><strong>Option ${i + 1}: ${esc(o.title)}</strong><br>`;
        if (o.description) h += `${esc(o.description)} `;
        if (o.implication) h += `<em>Implication: ${esc(o.implication)}</em>`;
        h += `</p>`;
      });
    }

    // Constraints
    if (data.budget || data.timeline || data.ethicalConstraints) {
      h += `<h2>Constraints</h2>`;
      if (data.budget) h += `<p><strong>Budget:</strong> ${esc(data.budget)}</p>`;
      if (data.timeline) h += `<p><strong>Timeline:</strong> ${esc(data.timeline)}</p>`;
      if (data.ethicalConstraints) h += `<p><strong>Ethical / Regulatory:</strong> ${esc(data.ethicalConstraints)}</p>`;
    }

    // Discussion Questions
    h += `<h2>Discussion Questions</h2>`;
    const questions = generateQuestions(validOpts, validSH);
    questions.forEach(q => {
      h += `<div class="discussion-q">${esc(q)}</div>`;
    });

    return h;
  }

  function generateQuestions(opts, stakeholders) {
    const qs = [];
    
    // Analysis questions
    if (opts.length >= 1) {
      qs.push(`What are the short-term and long-term consequences of pursuing "${opts[0].title}"? Consider financial, operational, and reputational impacts.`);
    }
    if (opts.length >= 2) {
      qs.push(`Compare the risks and benefits of "${opts[0].title}" versus "${opts[1].title}." Which better serves the organization's strategic goals and why?`);
    }
    
    // Stakeholder questions
    if (stakeholders.length > 0) {
      const names = stakeholders.slice(0, 3).map(s => s.name).join(', ');
      qs.push(`How might the interests of key stakeholders (${names}) conflict, and how should management balance those tensions? What happens if one group's needs are prioritized over others?`);
    }
    
    // Framework questions
    if (data.problemType === 'Ethics') {
      qs.push('Apply an ethical decision-making framework (e.g., utilitarianism, deontology, virtue ethics) to this situation. How does each framework inform the decision?');
    } else if (data.problemType === 'Strategic') {
      qs.push('What strategic frameworks (e.g., SWOT, Porter\'s Five Forces, PESTEL) would be most useful in analyzing this situation? Apply at least one framework to generate insights.');
    }
    
    // Data and research questions
    qs.push('What additional quantitative and qualitative data would you need before making a final recommendation? How would you obtain this information, and what challenges might you face?');
    
    // Decision-making questions
    if (data.ethicalConstraints) {
      qs.push('What ethical and regulatory considerations should guide the decision-making process? How might they override purely financial or operational logic?');
    }
    
    // Implementation questions
    if (opts.length > 0) {
      qs.push('If you were to implement your recommended option, what would be your action plan? What are the critical success factors and potential obstacles?');
    }
    
    // Alternative perspectives
    qs.push('If you were in the decision maker\'s position, what would you decide and why? What assumptions underlie your choice, and how would you test them?');
    
    // Risk and contingency
    qs.push('What are the key risks associated with your recommended course of action? What contingency plans should be in place?');
    
    return qs.slice(0, 8);
  }

  // ‚îÄ‚îÄ Markdown ‚îÄ‚îÄ
  function buildMarkdown() {
    const title = data.title || 'Untitled Case Study';
    const yr = data.year || new Date().getFullYear();
    const industry = data.industry || 'Not specified';
    const region = data.region || 'Not specified';
    const company = data.company || '[Company]';

    let md = `# ${title}\n\n`;
    md += `**${company}** ¬∑ ${industry} ¬∑ ${region} ¬∑ ${yr}\n\n---\n\n`;

    md += `## Company Overview\n\n`;
    md += `${company} operates in the ${industry.toLowerCase()} sector in ${region}.`;
    if (data.role) {
      if (data.decisionMakerName) {
        md += ` The case centers on ${data.decisionMakerName}, a ${data.role}`;
      } else {
        md += ` The case centers on a ${data.role}`;
      }
      if (data.experience) md += ` with approximately ${data.experience} years of professional experience`;
      md += `.`;
    }
    if (data.background) md += ` ${data.background}`;
    md += `\n\n`;

    md += `## Background and Problem Statement\n\n`;
    if (data.problemType) md += `**Category:** ${data.problemType}\n\n`;
    md += `${data.problem || 'No problem description provided.'}\n\n`;

    const validSH = data.stakeholders.filter(s => s.name);
    if (validSH.length) {
      md += `## Key Stakeholders\n\n`;
      validSH.forEach(s => {
        md += `- **${s.name}**`;
        if (s.interest) md += `: ${s.interest}`;
        md += `\n`;
      });
      md += `\n`;
    }

    const validOpts = data.options.filter(o => o.title);
    if (validOpts.length) {
      md += `## Available Options\n\n`;
      validOpts.forEach((o, i) => {
        md += `### Option ${i + 1}: ${o.title}\n\n`;
        if (o.description) md += `${o.description}\n\n`;
        if (o.implication) md += `*Implication: ${o.implication}*\n\n`;
      });
    }

    if (data.budget || data.timeline || data.ethicalConstraints) {
      md += `## Constraints\n\n`;
      if (data.budget) md += `**Budget:** ${data.budget}\n\n`;
      if (data.timeline) md += `**Timeline:** ${data.timeline}\n\n`;
      if (data.ethicalConstraints) md += `**Ethical / Regulatory:** ${data.ethicalConstraints}\n\n`;
    }

    md += `## Discussion Questions\n\n`;
    const questions = generateQuestions(validOpts, validSH);
    questions.forEach((q, i) => { md += `${i + 1}. ${q}\n`; });
    md += `\n---\n\n*Generated using the Case Study Builder, a teaching tool conceptualized by [Professor Babu George](https://www.linkedin.com/in/beingbabu/).*\n`;

    return md;
  }

  // ‚îÄ‚îÄ Word export (HTML-based .doc) ‚îÄ‚îÄ
  function buildWordHTML() {
    const caseHTML = buildCaseHTML();
    return `<!DOCTYPE html>
<html><head><meta charset="utf-8">
<style>
  body { font-family: Cambria, Georgia, serif; font-size: 12pt; color: #1e293b; line-height: 1.7; max-width: 7in; margin: 0.5in auto; }
  h1 { font-size: 20pt; color: #1e293b; margin-bottom: 4pt; }
  h2 { font-size: 14pt; color: #4a6fa5; border-bottom: 1pt solid #ddd; padding-bottom: 4pt; margin-top: 18pt; }
  .case-meta { font-family: Calibri, sans-serif; font-size: 10pt; color: #64748b; border-bottom: 2pt solid #eee; padding-bottom: 10pt; margin-bottom: 18pt; }
  ul, ol { margin-left: 0.3in; }
  li { margin-bottom: 4pt; }
  .discussion-q { background: #e8eef6; border-left: 3pt solid #4a6fa5; padding: 8pt 12pt; margin-bottom: 6pt; font-style: italic; }
  p { margin-bottom: 8pt; }
  em { color: #555; }
</style></head><body>${caseHTML}
<hr style="margin-top:24pt;border:none;border-top:1pt solid #ccc;">
<p style="font-size:9pt;color:#94a3b8;text-align:center;">Generated using the Case Study Builder, a teaching tool conceptualized by <a href="https://www.linkedin.com/in/beingbabu/">Professor Babu George</a>.</p>
</body></html>`;
  }

  // ‚îÄ‚îÄ Exports ‚îÄ‚îÄ
  window.downloadMarkdown = function() {
    const md = buildMarkdown();
    const slug = (data.title || 'case_study').replace(/[^a-z0-9]+/gi, '_').toLowerCase();
    downloadBlob(md, `${slug}.md`, 'text/markdown');
    showToast('Markdown file downloaded', 'success');
  };

  window.downloadWord = function() {
    const html = buildWordHTML();
    const slug = (data.title || 'case_study').replace(/[^a-z0-9]+/gi, '_').toLowerCase();
    const blob = new Blob(['\ufeff' + html], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${slug}.doc`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast('Word document downloaded', 'success');
  };

  window.downloadPDF = function() {
    window.print();
    showToast('Use your browser\'s Save as PDF option', 'info');
  };

  window.downloadJSON = function() {
    const exportData = {
      title: data.title,
      metadata: {
        industry: data.industry,
        company: data.company,
        region: data.region,
        year: data.year
      },
      decisionMaker: {
        role: data.role,
        experience: data.experience,
        background: data.background
      },
      problem: {
        description: data.problem,
        type: data.problemType
      },
      stakeholders: data.stakeholders.filter(s => s.name),
      options: data.options.filter(o => o.title),
      constraints: {
        budget: data.budget,
        timeline: data.timeline,
        ethical: data.ethicalConstraints
      },
      exportedAt: new Date().toISOString()
    };
    
    const json = JSON.stringify(exportData, null, 2);
    const slug = (data.title || 'case_study').replace(/[^a-z0-9]+/gi, '_').toLowerCase();
    downloadBlob(json, `${slug}.json`, 'application/json');
    showToast('JSON file downloaded', 'success');
  };

  window.copyMarkdown = function() {
    const md = buildMarkdown();
    navigator.clipboard.writeText(md).then(() => showToast('Copied to clipboard', 'success')).catch(() => {
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = md;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      showToast('Copied to clipboard', 'success');
    });
  };

  function downloadBlob(content, filename, mime) {
    const blob = new Blob([content], { type: mime });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  // ‚îÄ‚îÄ Render result ‚îÄ‚îÄ
  function renderResult() {
    const caseHTML = buildCaseHTML();
    app.innerHTML = `<div class="result-wrap">
      <div class="result-actions">
        <button class="btn btn-primary" onclick="downloadWord()">üìÑ Download Word</button>
        <button class="btn btn-primary" onclick="downloadPDF()">üñ®Ô∏è Save as PDF</button>
        <button class="btn btn-secondary" onclick="downloadMarkdown()">‚¨áÔ∏è Markdown</button>
        <button class="btn btn-secondary" onclick="downloadJSON()">üìä JSON</button>
        <button class="btn btn-secondary" onclick="copyMarkdown()">üìã Copy</button>
        <button class="btn btn-danger" onclick="startOver()">‚Üª Start Over</button>
      </div>
      <div class="result-content" id="resultContent">${caseHTML}</div>
    </div>`;
  }

  // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
  // Load autosave on startup
  const hasAutoSave = loadAutoSave();
  if (hasAutoSave && !showingResult) {
    console.log('Restored from autosave');
  }
  
  // Update saved cases badge
  updateSavedCasesBadge();
  
  // Render initial view
  render();

  // ‚îÄ‚îÄ Service Worker Registration ‚îÄ‚îÄ
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(registration => {
          console.log('ServiceWorker registered:', registration.scope);
          
          // Check for updates
          registration.addEventListener('updatefound', () => {
            const newWorker = registration.installing;
            newWorker.addEventListener('statechange', () => {
              if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                showToast('New version available! Reload to update.', 'info');
              }
            });
          });
        })
        .catch(err => console.log('ServiceWorker registration failed:', err));
    });
  }

  // ‚îÄ‚îÄ PWA Install Prompt ‚îÄ‚îÄ
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Show a subtle notification instead of confirm dialog
    setTimeout(() => {
      const installToast = document.createElement('div');
      installToast.className = 'toast show';
      installToast.innerHTML = 'üì± Install this app for offline access! <button style="margin-left:10px;background:#fff;color:var(--text);border:none;padding:4px 12px;border-radius:4px;cursor:pointer;" onclick="this.parentElement.remove(); if(window.deferredPrompt) { window.deferredPrompt.prompt(); window.deferredPrompt.userChoice.then((r) => { if(r.outcome === \'accepted\') showToast(\'App installed!\', \'success\'); window.deferredPrompt = null; }); }">Install</button>';
      document.body.appendChild(installToast);
      
      setTimeout(() => {
        installToast.remove();
      }, 8000);
    }, 5000); // Show after 5 seconds
  });
  
  window.deferredPrompt = deferredPrompt;

  // ‚îÄ‚îÄ Tooltip click/touch support ‚îÄ‚îÄ
  document.addEventListener('click', (e) => {
    const helpBtn = e.target.closest('.field-help');
    // Close all other open tooltips first
    document.querySelectorAll('.field-help.active').forEach(el => {
      if (el !== helpBtn) el.classList.remove('active');
    });
    if (helpBtn) {
      e.stopPropagation();
      helpBtn.classList.toggle('active');
    }
  });

  // ‚îÄ‚îÄ Keyboard shortcuts ‚îÄ‚îÄ
  document.addEventListener('keydown', (e) => {
    // Ctrl/Cmd + S to save
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      saveCurrentCase();
    }
    // Ctrl/Cmd + K to open saved cases
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      toggleSavedCases();
    }
  });

})();
</script>
</body>
</html>
